package com.sofis.web.mb;

import com.sofis.business.constantes.ConfiguracionConstantes;
import com.sofis.business.utils.EntregablesUtils;
import com.sofis.entities.constantes.ConstanteApp;
import com.sofis.entities.constantes.ConstantesEstandares;
import com.sofis.entities.data.EntHistLineaBase;
import com.sofis.entities.data.Entregables;
import com.sofis.entities.data.Estados;
import com.sofis.entities.data.Moneda;
import com.sofis.entities.data.Presupuesto;
import com.sofis.entities.data.ProdMes;
import com.sofis.entities.data.Productos;
import com.sofis.entities.data.Proyectos;
import com.sofis.entities.tipos.FichaTO;
import com.sofis.entities.tipos.ReporteAcumuladoMesTO;
import com.sofis.entities.tipos.ReporteAcumuladoTO;
import com.sofis.generico.utils.generalutils.CollectionsUtils;
import com.sofis.generico.utils.generalutils.DatesUtils;
import com.sofis.web.delegates.ConfiguracionDelegate;
import com.sofis.web.delegates.EntHistLineaBaseDelegate;
import com.sofis.web.delegates.PresupuestoDelegate;
import com.sofis.web.delegates.ProductosDelegate;
import com.sofis.web.delegates.ProyectosDelegate;
import com.sofis.web.properties.Labels;
import java.io.Serializable;
import java.util.ArrayList;
import java.util.Calendar;
import java.util.Date;
import java.util.GregorianCalendar;
import java.util.HashSet;
import java.util.List;
import java.util.logging.Logger;
import javax.annotation.PostConstruct;
import javax.faces.bean.ManagedBean;
import javax.faces.bean.ManagedProperty;
import javax.faces.bean.ViewScoped;
import javax.faces.context.FacesContext;
import javax.inject.Inject;
import javax.servlet.http.HttpServletRequest;

/**
 *
 * @author Usuario
 */
@ManagedBean(name = "reporteProyectoMB")
@ViewScoped
public class ReporteProyectoMB implements Serializable {

    private static final long serialVersionUID = 1L;
    private static final Logger logger = Logger.getLogger(ConstanteApp.LOGGER_NAME);
    private static final String REPORTE_PROY_PK = "reporteProyPk";
    private static final String REPORTE_TIPO = "reporteTipo";
    private static final int INICIO_REPORTE_GANTT = 5;
    private static final int FIN_REPORTE_GANTT = 580;
    @ManagedProperty("#{inicioMB}")
    InicioMB inicioMB;
    @ManagedProperty("#{fichaMB}")
    FichaMB fichaMB;
    @Inject
    ProyectosDelegate proyectoDelegate;
    @Inject
    ProductosDelegate productosDelegate;
    @Inject
    PresupuestoDelegate presupuestoDelegate;
    @Inject
    ConfiguracionDelegate configuracionDelegate;
    @Inject
    EntHistLineaBaseDelegate entHistLineaBaseDelegate;
    private List<Entregables> listaEntregables;
    private List<ReporteAcumuladoTO> listaAcumulados;
    private Integer anio;

    public ReporteProyectoMB() {
        this.listaAcumulados = new ArrayList<>();
    }

    public void setInicioMB(InicioMB inicioMB) {
        this.inicioMB = inicioMB;
    }

    public InicioMB getInicioMB() {
        return inicioMB;
    }

    public FichaMB getFichaMB() {
        return fichaMB;
    }

    public void setFichaMB(FichaMB fichaMB) {
        this.fichaMB = fichaMB;
    }

    public FichaTO getFichaTO() {
        return this.fichaMB.getFichaTO();
    }

    public List<Entregables> getListaEntregables() {
        return listaEntregables;
    }

    public void setListaEntregables(List<Entregables> listaEntregables) {
        this.listaEntregables = listaEntregables;
    }

    public List<ReporteAcumuladoTO> getListaAcumulados() {
        return listaAcumulados;
    }

    public void setListaAcumulados(List<ReporteAcumuladoTO> listaAcumulados) {
        this.listaAcumulados = listaAcumulados;
    }

    public Integer getAnio() {
        return anio;
    }

    public void setAnio(Integer anio) {
        this.anio = anio;
    }

    @PostConstruct
    public void init() {

        Integer reporteProyPk = (Integer) getFlashContext(REPORTE_PROY_PK);
        if (reporteProyPk == null) {
            HttpServletRequest request = (HttpServletRequest) FacesContext.getCurrentInstance().getExternalContext().getRequest();
            reporteProyPk = (Integer) request.getSession().getAttribute(REPORTE_PROY_PK);
            request.getSession().removeAttribute(REPORTE_PROY_PK);
        }

        if (reporteProyPk != null) {
            String reporteTipo = (String) getFlashContext(REPORTE_TIPO);
            if (reporteTipo == null) {
                HttpServletRequest request = (HttpServletRequest) FacesContext.getCurrentInstance().getExternalContext().getRequest();
                reporteTipo = (String) request.getSession().getAttribute(REPORTE_TIPO);
                request.getSession().removeAttribute(REPORTE_TIPO);
            }

            int proyPk = reporteProyPk.intValue();
            if (reporteTipo == null || reporteTipo.equalsIgnoreCase("proyecto")) {
                cargarReporte(proyPk);
            } else if (reporteTipo.equalsIgnoreCase("cronograma")) {
                cargarCronograma(proyPk);
            }
        }
    }

    private Object getFlashContext(String attName) {
        return FacesContext.getCurrentInstance().getExternalContext().getFlash().get(attName);
    }

    private void cargarReporte(int proyPk) {
        Proyectos proy = proyectoDelegate.obtenerProyPorId(proyPk);
        fichaMB.proyectoToFichaTO(proy);

        Calendar cal = new GregorianCalendar();
        anio = cal.get(Calendar.YEAR);
        Integer ultimoAnio = EntregablesUtils.obtenerUltimoAnio(listaEntregables);
        if (ultimoAnio != null && ultimoAnio < anio) {
            anio = ultimoAnio;
        }

        listaEntregables = new ArrayList(fichaMB.getFichaTO().getCroFk().getEntregablesSet());
        //ordenamos los entregables por el numero
        listaEntregables = EntregablesUtils.sortById(listaEntregables);

        fichaMB.cargarResumenRiesgos();
        fichaMB.cargarResumenPresupuesto();
        fichaMB.cargarResumenCronograma();

        cargarTablaAcumulados(proyPk);
    }

    private void cargarCronograma(int proyPk) {
        Proyectos proy = proyectoDelegate.obtenerProyPorId(proyPk);
        fichaMB.proyectoToFichaTO(proy);

        Calendar cal = new GregorianCalendar();
        anio = cal.get(Calendar.YEAR);
        Integer ultimoAnio = EntregablesUtils.obtenerUltimoAnio(listaEntregables);
        if (ultimoAnio != null && ultimoAnio < anio) {
            anio = ultimoAnio;
        }

        listaEntregables = new ArrayList(fichaMB.getFichaTO().getCroFk().getEntregablesSet());
        //ordenamos los entregables por el numero
        listaEntregables = EntregablesUtils.sortById(listaEntregables);

        for (Entregables ent : listaEntregables) {
            List<EntHistLineaBase> entHistList = entHistLineaBaseDelegate.obtenerEntHistPorEntPk(ent.getEntPk());
            ent.setEntHistLBSet(new HashSet<>(entHistList));
        }

        fichaMB.cargarResumenRiesgos();
        fichaMB.cargarResumenPresupuesto();
        fichaMB.cargarResumenCronograma();

        cargarTablaAcumulados(proyPk);
    }

    public String estadoStr(Estados est) {
        if (est != null) {
            return Labels.getValue("estado_" + est.getEstPk());
        }
        return "";
    }

    public int calcularLeftEntByDate(Date inicio) {
        return EntregablesUtils.calcularLeftEntByDate(inicio, anio, INICIO_REPORTE_GANTT, FIN_REPORTE_GANTT);
    }

    public int calcularWitdhEntByDate(Date inicio, Date fin, Integer duracion) {
        return EntregablesUtils.calcularWitdhEntByDate(inicio, fin, duracion, anio, INICIO_REPORTE_GANTT, FIN_REPORTE_GANTT);
    }

    public boolean contieneAnioMenor() {
        if (CollectionsUtils.isNotEmpty(listaEntregables)) {
            Calendar cal = new GregorianCalendar();
            for (Entregables ent : listaEntregables) {
                cal.setTime(ent.getEntInicioDate());
                if (cal.get(Calendar.YEAR) < anio) {
                    return true;
                }
            }
        }
        if (CollectionsUtils.isNotEmpty(listaAcumulados)) {
            for (ReporteAcumuladoTO acu : listaAcumulados) {
                for (ReporteAcumuladoMesTO acuMes : acu.getMeses()) {
                    if (acuMes.getAnio() < anio) {
                        return true;
                    }
                }
            }
        }
        return false;
    }

    public boolean contieneAnioMayor() {
        if (CollectionsUtils.isNotEmpty(listaEntregables)) {
            Calendar cal = new GregorianCalendar();
            for (Entregables ent : listaEntregables) {
                cal.setTime(ent.getEntFinDate());
                if (cal.get(Calendar.YEAR) > anio) {
                    return true;
                }
            }
        }
        if (CollectionsUtils.isNotEmpty(listaAcumulados)) {
            for (ReporteAcumuladoTO acu : listaAcumulados) {
                for (ReporteAcumuladoMesTO acuMes : acu.getMeses()) {
                    if (acuMes.getAnio() > anio) {
                        return true;
                    }
                }
            }
        }

        return false;
    }

    public String retrocederAnio() {
        anio--;
        return null;
    }

    public String avanzarAnio() {
        anio++;
        return null;
    }

    public boolean displayEnt(Entregables ent) {
        return DatesUtils.isAnioEntreFechas(ent.getEntInicioDate(), ent.getEntFinLineaBaseDate(), anio);
    }

    public boolean displayEntHist(EntHistLineaBase entHistLB) {
        return DatesUtils.isAnioEntreFechas(entHistLB.getEnthistInicioLineaBaseDate(), entHistLB.getEnthistFinLineaBaseDate(), anio);
    }

    public boolean entAtrasado(Entregables ent) {
        if (ent != null) {
            Calendar cal = new GregorianCalendar();
            Calendar calFin = new GregorianCalendar();
            calFin.setTime(ent.getEntFinDate());
            Calendar calFinBase = null;
            if (ent.getEntFinLineaBaseDate() != null) {
                calFinBase = new GregorianCalendar();
                calFinBase.setTime(ent.getEntFinLineaBaseDate());
            }

            if (calFin.before(cal) || (calFinBase != null && calFin.after(calFinBase))) {
                return true;
            }
        }
        return false;
    }

    private void cargarTablaAcumulados(Integer proyPk) {
        if (proyPk != null) {
            Integer orgPk = inicioMB.getOrganismo().getOrgPk();
            // Productos
            List<Productos> productos = productosDelegate.obtenerProdPorProyPk(proyPk);
            Integer limiteAmarilloProd = Integer.valueOf(configuracionDelegate.obtenerCnfPorCodigoYOrg(ConfiguracionConstantes.PRODUCTO_INDICE_LIMITE_AMARILLO, orgPk).getCnfValor());
            Integer limiteRojoProd = Integer.valueOf(configuracionDelegate.obtenerCnfPorCodigoYOrg(ConfiguracionConstantes.PRODUCTO_INDICE_LIMITE_ROJO, orgPk).getCnfValor());

            for (Productos prod : productos) {
                ReporteAcumuladoTO acumulado = new ReporteAcumuladoTO();
                acumulado.setTitulo(Labels.getValue("reporte_proy_prod_titulo"));
                acumulado.setNombre(prod.getProdDesc());
                acumulado.setDescPlan(Labels.getValue("prod_resumen_plan"));
                acumulado.setDescReal(Labels.getValue("prod_resumen_valor"));

                if (CollectionsUtils.isNotEmpty(prod.getProdMesList())) {
                    for (ProdMes prodMes : prod.getProdMesList()) {
                        String colorR = productosDelegate.prodMesAcuRealColor(prodMes.getProdmesPk(), orgPk, limiteAmarilloProd, limiteRojoProd);
                        acumulado.setMes(prodMes.getProdmesAnio(), prodMes.getProdmesMes(), prodMes.getProdmesPk(), prodMes.getProdmesAcuPlan(), prodMes.getProdmesAcuReal(), colorR);
                    }
                }

                listaAcumulados.add(acumulado);
            }

            // Presupuesto
            Presupuesto pre = presupuestoDelegate.obtenerPresupuestoPorProy(proyPk);
            List<Moneda> monedasPresupuesto = presupuestoDelegate.obtenerMonedasPresupuesto(pre.getPrePk());

            Integer limiteAmarilloPre = Integer.valueOf(configuracionDelegate.obtenerCnfPorCodigoYOrg(ConfiguracionConstantes.COSTO_ACTUAL_LIMITE_AMARILLO, orgPk).getCnfValor());
            Integer limiteRojoPre = Integer.valueOf(configuracionDelegate.obtenerCnfPorCodigoYOrg(ConfiguracionConstantes.COSTO_ACTUAL_LIMITE_ROJO, orgPk).getCnfValor());

            Date inicio = presupuestoDelegate.obtenerPrimeraFechaPre(pre);
            Date fin = presupuestoDelegate.obtenerUltimaFechaPre(pre);

            for (Moneda moneda : monedasPresupuesto) {
                ReporteAcumuladoTO acumulado = new ReporteAcumuladoTO();
                acumulado.setTitulo(Labels.getValue("reporte_proy_pre_titulo"));
                acumulado.setNombre(moneda.getMonSigno());
                acumulado.setDescPlan(Labels.getValue("presupuesto_resumen_pv"));
                acumulado.setDescReal(Labels.getValue("presupuesto_resumen_ac"));

                if (inicio != null && fin != null) {
                    Calendar calIni = new GregorianCalendar();
                    calIni.setTime(inicio);
                    Calendar calFin = new GregorianCalendar();
                    calFin.setTime(fin);

                    Calendar calAux = calIni;

                    while (calAux.get(Calendar.YEAR) < calFin.get(Calendar.YEAR)
                            || (calAux.get(Calendar.YEAR) == calFin.get(Calendar.YEAR)
                            && calAux.get(Calendar.MONTH) <= calFin.get(Calendar.MONTH))) {
                        short anioP = (short) calAux.get(Calendar.YEAR);
                        short mesP = (short) (calAux.get(Calendar.MONTH) + 1);

                        Double pvMes = presupuestoDelegate.obtenerPVPorMoneda(pre.getPrePk(), moneda, anioP, mesP);
                        Double acMes = presupuestoDelegate.obtenerACPorMoneda(pre.getPrePk(), moneda, anioP, mesP);

                        String colorR = presupuestoDelegate.obtenerColorACMensual(pre.getPrePk(), moneda.getMonPk(), orgPk, anioP, mesP, limiteAmarilloPre, limiteRojoPre);

                        acumulado.setMes(anioP, mesP, null, pvMes, acMes, colorR);

                        calAux.add(Calendar.MONTH, 1);
                    }
                }
                listaAcumulados.add(acumulado);
            }
        }
    }

    public ReporteAcumuladoMesTO getAcumuladoMesAnio(ReporteAcumuladoTO acu, int mes) {
        if (CollectionsUtils.isNotEmpty(acu.getMeses())) {
            for (ReporteAcumuladoMesTO acuMes : acu.getMeses()) {
                if (acuMes.getAnio() == this.anio && acuMes.getMes() == mes) {
                    return acuMes;
                }
            }
        }
        return null;
    }

    public String getAcumuladoMesAnioColor(ReporteAcumuladoTO acu, int mes) {
        ReporteAcumuladoMesTO acuMes = getAcumuladoMesAnio(acu, mes);
        return acuMes != null ? acuMes.getColorReal() : ConstantesEstandares.COLOR_TRANSPARENT;
    }

    public String semaforosUtilizados() {
        Integer orgPk = inicioMB.getOrganismo().getOrgPk();

        Integer limiteAmarilloProd = Integer.valueOf(configuracionDelegate.obtenerCnfPorCodigoYOrg(ConfiguracionConstantes.PRODUCTO_INDICE_LIMITE_AMARILLO, orgPk).getCnfValor());
        Integer limiteRojoProd = Integer.valueOf(configuracionDelegate.obtenerCnfPorCodigoYOrg(ConfiguracionConstantes.PRODUCTO_INDICE_LIMITE_ROJO, orgPk).getCnfValor());

        Integer limiteAmarilloPre = Integer.valueOf(configuracionDelegate.obtenerCnfPorCodigoYOrg(ConfiguracionConstantes.COSTO_ACTUAL_LIMITE_AMARILLO, orgPk).getCnfValor());
        Integer limiteRojoPre = Integer.valueOf(configuracionDelegate.obtenerCnfPorCodigoYOrg(ConfiguracionConstantes.COSTO_ACTUAL_LIMITE_ROJO, orgPk).getCnfValor());

        StringBuffer result = new StringBuffer();
        result.append("<b>Productos:</b><br/>")
                .append("Azul: Real es mayor o igual al total Planificado.<br/>")
                .append(String.format("Verde: Real es menor al total Planificado y mayor a %s%%.<br/>", (100 - limiteAmarilloProd)))
                .append(String.format("Amarillo: Real es menor o igual a %s%% y mayor a %s%%.<br/>", (100 - limiteAmarilloProd), (100 - limiteRojoProd)))
                .append(String.format("Rojo: Real es menor a %s%%.<br/>", (100 - limiteRojoProd)));

        result.append("<b>Presupuesto:</b><br/>")
                .append(String.format("Verde: Real es mayor o igual a %s%% y menor o igual a %s%%.<br/>", (100 - limiteAmarilloPre), (100 + limiteAmarilloPre)))
                .append(String.format("Amarillo: Real es mayor o igual a %s%% y menor o igual a %s%%.<br/>", (100 - limiteRojoPre), (100 + limiteRojoPre)))
                .append(String.format("Naranja: Real es menor a %s%%.<br/>", (100 - limiteRojoPre)))
                .append(String.format("Rojo: Real es mayor a %s%%.<br/>", (100 + limiteRojoPre)));

        return result.toString();
    }
}
