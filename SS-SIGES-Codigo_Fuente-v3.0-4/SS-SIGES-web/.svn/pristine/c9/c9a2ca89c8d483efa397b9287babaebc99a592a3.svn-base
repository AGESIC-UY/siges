package com.sofis.web.mb;

import com.sofis.business.utils.EntregablesUtils;
import com.sofis.business.utils.RegistroHorasUtils;
import com.sofis.entities.constantes.ConstanteApp;
import com.sofis.entities.data.Entregables;
import com.sofis.entities.data.Participantes;
import com.sofis.entities.data.Proyectos;
import com.sofis.entities.data.RegistrosHoras;
import com.sofis.entities.data.SsUsuario;
import com.sofis.entities.validations.FichaParticipantesValidacion;
import com.sofis.exceptions.BusinessException;
import com.sofis.exceptions.GeneralException;
import com.sofis.exceptions.TechnicalException;
import com.sofis.web.delegates.ParticipantesDelegate;
import com.sofis.web.delegates.ProyectosDelegate;
import com.sofis.web.delegates.RegistrosHorasDelegate;
import com.sofis.web.delegates.SsUsuarioDelegate;
import com.sofis.web.properties.Labels;
import com.sofis.web.utils.JSFUtils;
import com.sofis.web.utils.SofisCombo;
import java.io.Serializable;
import java.util.ArrayList;
import java.util.Calendar;
import java.util.Collections;
import java.util.Date;
import java.util.LinkedList;
import java.util.List;
import java.util.logging.Level;
import java.util.logging.Logger;
import javax.annotation.PostConstruct;
import javax.faces.bean.ManagedBean;
import javax.faces.bean.ManagedProperty;
import javax.faces.bean.ViewScoped;
import javax.faces.event.PhaseId;
import javax.faces.event.ValueChangeEvent;
import javax.faces.model.SelectItem;
import javax.inject.Inject;

/**
 *
 * @author Usuario
 */
@ManagedBean(name = "revisionHorasMB")
@ViewScoped
public class RevisionHorasMB implements Serializable {

    private static final long serialVersionUID = 1L;
    private static final Logger logger = Logger.getLogger(ConstanteApp.LOGGER_NAME);
    private static final String PARTICIPANTE_MSG_ID = "participantesMsg";
    private static final String PARTICIPANTE_HORAS_MSG_ID = "partHorasMsg";
    private static final String PARTICIPANTE_GASTOS_MSG_ID = "partGastosMsg";
    private static final String PARTICIPANTE_POPUP_MSG_ID = "participantesPopupMsg";
    @ManagedProperty("#{inicioMB}")
    InicioMB inicioMB;
    @ManagedProperty("#{fichaMB}")
    FichaMB fichaMB;
    @Inject
    ProyectosDelegate proyectoDelegate;
    @Inject
    RegistrosHorasDelegate registrosHorasDelegate;
    @Inject
    ParticipantesDelegate participantesDelegate;
    @Inject
    SsUsuarioDelegate ssUsuarioDelegate;
    //Atributos
    private List<RegistrosHoras> revisionHorasListado;
    private Participantes participante = null;
    private int cantElementosPorPagina = 25;
    //0=Listado Part., 1=Detalle Horas, 2=Detalle Gastos.
    private int renderedHorasGastos;
    //Para el filtro
    private Integer filtroProyPk;
    private Date filtroFechaDesde;
    private Date filtroFechaHasta;
    private List<Entregables> listaEntregablesFiltro;
    private SofisCombo listaEntregablesCombo;
    private List<SelectItem> listaAprobItems;
    private SofisCombo listaAprobCombo;
    private Integer tipoRegistro;
    //Para la generacion de horas
    private Integer generarHorasEntPk;
    private Date generarHorasFechaDesde;
    private Date generarHorasFechaHasta;
    private Float generarHorasHorasDiarias;
    private boolean renderPopupGenerarHoras;
    private Boolean todoAprobado;
    //Participantes
    private List<SsUsuario> listaUsuarios;
    private SofisCombo listaUsuariosCombo;

    public RevisionHorasMB() {
        renderedHorasGastos = 0;
        renderPopupGenerarHoras = false;
        participante = new Participantes();
        listaUsuariosCombo = new SofisCombo();
        listaEntregablesCombo = new SofisCombo();
    }

    public List<RegistrosHoras> getRevisionHorasListado() {
        return revisionHorasListado;
    }

    public Integer getFiltroProyPk() {
        return filtroProyPk;
    }

    public void setFiltroProyPk(Integer filtroProyPk) {
        this.filtroProyPk = filtroProyPk;
    }

    public Date getFiltroFechaDesde() {
        return filtroFechaDesde;
    }

    public void setFiltroFechaDesde(Date filtroFechaDesde) {
        this.filtroFechaDesde = filtroFechaDesde;
    }

    public Date getFiltroFechaHasta() {
        return filtroFechaHasta;
    }

    public void setFiltroFechaHasta(Date filtroFechaHasta) {
        this.filtroFechaHasta = filtroFechaHasta;
    }

    public List<Entregables> getListaEntregablesFiltro() {
        return listaEntregablesFiltro;
    }

    public SofisCombo getListaEntregablesCombo() {
        return listaEntregablesCombo;
    }

    public void setListaEntregablesCombo(SofisCombo listaEntregablesCombo) {
        this.listaEntregablesCombo = listaEntregablesCombo;
    }

    public List<SelectItem> getListaAprobItems() {
        return listaAprobItems;
    }

    public void setListaAprobItems(List<SelectItem> listaAprobItems) {
        this.listaAprobItems = listaAprobItems;
    }

    public SofisCombo getListaAprobCombo() {
        return listaAprobCombo;
    }

    public void setListaAprobCombo(SofisCombo listaAprobCombo) {
        this.listaAprobCombo = listaAprobCombo;
    }

    public Integer getTipoRegistro() {
        return tipoRegistro;
    }

    public void setTipoRegistro(Integer tipoRegistro) {
        this.tipoRegistro = tipoRegistro;
    }

    public Participantes getParticipante() {
        return participante;
    }

    public void setParticipante(Participantes participante) {
        this.participante = participante;
    }

    public int getCantElementosPorPagina() {
        return cantElementosPorPagina;
    }

    public void setCantElementosPorPagina(int cantElementosPorPagina) {
        this.cantElementosPorPagina = cantElementosPorPagina;
    }

    public void setInicioMB(InicioMB inicioMB) {
        this.inicioMB = inicioMB;
    }

    public void setFichaMB(FichaMB fichaMB) {
        this.fichaMB = fichaMB;
    }

    public void setProyectoDelegate(ProyectosDelegate proyectoDelegate) {
        this.proyectoDelegate = proyectoDelegate;
    }

    public void setRegistrosHorasDelegate(RegistrosHorasDelegate registrosHorasDelegate) {
        this.registrosHorasDelegate = registrosHorasDelegate;
    }

    public Integer getGenerarHorasEntPk() {
        return generarHorasEntPk;
    }

    public void setGenerarHorasEntPk(Integer generarHorasEntPk) {
        this.generarHorasEntPk = generarHorasEntPk;
    }

    public Date getGenerarHorasFechaDesde() {
        return generarHorasFechaDesde;
    }

    public void setGenerarHorasFechaDesde(Date generarHorasFechaDesde) {
        this.generarHorasFechaDesde = generarHorasFechaDesde;
    }

    public Date getGenerarHorasFechaHasta() {
        return generarHorasFechaHasta;
    }

    public void setGenerarHorasFechaHasta(Date generarHorasFechaHasta) {
        this.generarHorasFechaHasta = generarHorasFechaHasta;
    }

    public Float getGenerarHorasHorasDiarias() {
        return generarHorasHorasDiarias;
    }

    public void setGenerarHorasHorasDiarias(Float generarHorasHorasDiarias) {
        this.generarHorasHorasDiarias = generarHorasHorasDiarias;
    }

    public boolean isRenderPopupGenerarHoras() {
        return renderPopupGenerarHoras;
    }

    public void setRenderPopupGenerarHoras(boolean renderPopupGenerarHoras) {
        this.renderPopupGenerarHoras = renderPopupGenerarHoras;
    }

    public Boolean getTodoAprobado() {
        return todoAprobado;
    }

    public void setTodoAprobado(Boolean todoAprobado) {
        this.todoAprobado = todoAprobado;
    }

    public List<SsUsuario> getListaUsuarios() {
        return listaUsuarios;
    }

    public void setListaUsuarios(List<SsUsuario> listaUsuarios) {
        this.listaUsuarios = listaUsuarios;
    }

    public SofisCombo getListaUsuariosCombo() {
        return listaUsuariosCombo;
    }

    public void setListaUsuariosCombo(SofisCombo listaUsuariosCombo) {
        this.listaUsuariosCombo = listaUsuariosCombo;
    }

    public int getRenderedHorasGastos() {
        return renderedHorasGastos;
    }

    public void setRenderedHorasGastos(int renderedHorasGastos) {
        this.renderedHorasGastos = renderedHorasGastos;
    }

    @PostConstruct
    public void init() {
        inicializarRevisionHoras();
    }

    private void inicializarRevisionHoras() {
        participante = new Participantes();
        participante.setPartProyectoFk(null);
        participante.setPartUsuarioFk(new SsUsuario(0));

//        filtroProyPk = 0;
        filtroProyPk = fichaMB.getFichaTO().getFichaFk();
        cargarEntregablesProyectoFiltro(filtroProyPk);
        filtroFechaDesde = null;
        filtroFechaHasta = null;

        listaUsuarios = ssUsuarioDelegate.obtenerTodosPorOrganismo(inicioMB.getOrganismo().getOrgPk());
        if (listaUsuarios != null) {
            listaUsuariosCombo = new SofisCombo((List) listaUsuarios, "usuNombreApellido");
            listaUsuariosCombo.addEmptyItem(Labels.getValue("comboTodos"));
        }

        listaAprobItems = new ArrayList<>();
        listaAprobItems.add(new SelectItem(1, Labels.getValue("revisionHoras_aprobado")));
        listaAprobItems.add(new SelectItem(0, Labels.getValue("revisionHoras_pendiente")));
        listaAprobCombo = new SofisCombo((List) listaAprobItems, "label");
        listaAprobCombo.addEmptyItem(Labels.getValue("comboTodos"));
    }

    private void cargarEntregablesProyectoFiltro(Integer proyId) {
        listaEntregablesFiltro = new LinkedList<>();
        if (proyId != null && proyId.intValue() > 0) {
            Proyectos proy = proyectoDelegate.obtenerProyPorId(proyId);
            if (proy != null && proy.getProyCroFk() != null && proy.getProyCroFk().getEntregablesSet() != null) {
                listaEntregablesFiltro.addAll(proy.getProyCroFk().getEntregablesSet());
            }
        }
//        listaEntregablesFiltro.add(0, new Entregables(0, 0, " Todos ", 0));
        listaEntregablesFiltro = EntregablesUtils.textoComboPorId(listaEntregablesFiltro);
        if (listaEntregablesFiltro != null) {
            listaEntregablesCombo = new SofisCombo((List) listaEntregablesFiltro, "entNombre");
            listaEntregablesCombo.addEmptyItem(Labels.getValue("comboTodos"));
        }
    }

    public String buscarConFiltro() {
        Entregables entregable = (Entregables) listaEntregablesCombo.getSelectedObject();
        SelectItem aprob = (SelectItem) listaAprobCombo.getSelectedObject();
        revisionHorasListado = registrosHorasDelegate.obtenerRegistrosHoras(participante.getPartUsuarioFk().getUsuId(),
                participante.getPartProyectoFk().getProyPk(),
                (entregable != null ? entregable.getEntPk() : null),
                filtroFechaDesde, filtroFechaHasta, null, null,
                (aprob != null ? (Integer) aprob.getValue() : null));
        revisionHorasListado = RegistroHorasUtils.sortByFecha(revisionHorasListado);
        return null;
    }

    public String buscarSinFiltro() {
        //Aunque sea sin filtro, siempre incluye el usuario y el proyecto
        filtroFechaDesde = null;
        filtroFechaHasta = null;
        return buscarConFiltro();
    }

    public String guardar() {
        registrosHorasDelegate.registrarHoras(revisionHorasListado);

        renderedHorasGastos = 0;
        limpiarParticipante();
        fichaMB.actualizarFichaTO(null);
        fichaMB.cargarResumenParticipantes();
        return null;
    }

    public String cancelarHoras() {
        renderedHorasGastos = 0;
        return null;
    }

    public String mostrarPopupGenerarHoras() {
        renderPopupGenerarHoras = true;
        return null;
    }

    public String cerrarPopupGenerarHoras() {
        renderPopupGenerarHoras = false;
        return null;
    }

    public String confirmarGenerarHoras() {
        Entregables entregable = (Entregables) listaEntregablesCombo.getSelectedObject();
        if (entregable == null || entregable.getEntPk() <= 0
                || generarHorasFechaHasta == null
                || generarHorasFechaDesde == null
                || generarHorasFechaDesde.after(generarHorasFechaHasta)
                || generarHorasHorasDiarias == null
                || generarHorasHorasDiarias.intValue() < 0 || generarHorasHorasDiarias.intValue() > 24) {
            return null;
        }

        Proyectos proyecto = participante.getPartProyectoFk();
        SsUsuario usuario = participante.getPartUsuarioFk();
        RegistrosHoras registroHoras = null;

        Calendar cal = Calendar.getInstance();
        cal.setTime(generarHorasFechaDesde);

        while (!cal.getTime().after(generarHorasFechaHasta)) {
            if (!(cal.get(Calendar.DAY_OF_WEEK) == Calendar.SATURDAY
                    || cal.get(Calendar.DAY_OF_WEEK) == Calendar.SUNDAY)) {
                registroHoras = new RegistrosHoras();
                registroHoras.setRhAprobado(true);
                registroHoras.setRhComentario("Generado automáticamente");
                registroHoras.setRhEntregableFk(entregable);
                registroHoras.setRhFecha(cal.getTime());
                registroHoras.setRhHoras(generarHorasHorasDiarias);
                registroHoras.setRhProyectoFk(proyecto);
                registroHoras.setRhUsuarioFk(usuario);
                registrosHorasDelegate.registrarHoras(registroHoras);
            }

            cal.add(Calendar.DATE, 1);
        }
        buscarConFiltro();
        fichaMB.actualizarFichaTO(null);
        fichaMB.cargarResumenParticipantes();
        return cerrarPopupGenerarHoras();
    }

    public String cancelarGenerarHoras() {
        return cerrarPopupGenerarHoras();
    }

    public boolean getPermitirAcceso() {
        return participante != null;
    }

    public void limpiarFiltro() {
        listaEntregablesCombo.setSelected(-1);
        listaAprobCombo.setSelected(-1);
        filtroFechaDesde = null;
        filtroFechaHasta = null;
    }

    public String agregarParticipanteAction() {
        participante.setPartUsuarioFk((SsUsuario) listaUsuariosCombo.getSelectedObject());
        participante.setPartProyectoFk(new Proyectos(fichaMB.getFichaTO().getFichaFk()));
        participantesDelegate.guardar(participante);

        fichaMB.actualizarFichaTO(null);
        fichaMB.cargarResumenParticipantes();
        cerrarFormCollapsable();

        return null;
    }

    public String guardarParticipanteAction() {
        logger.fine("Agregar participantes a la Ficha.");
        try {
            //Verificar si el usuario ya no es un participante
            for (Participantes p : fichaMB.getFichaTO().getParticipantes()) {
                if (participante.getPartUsuarioFk().getUsuId().equals(p.getPartUsuarioFk().getUsuId())) {
                    return null;
                }
            }

            Integer proyId = Integer.valueOf(fichaMB.getFichaTO().getFichaFk());
            Proyectos proyecto = proyectoDelegate.obtenerProyPorId(proyId);
            participante.setPartProyectoFk(proyecto);

            FichaParticipantesValidacion.validar(participante);

            SsUsuario usu = ssUsuarioDelegate.obtenerSsUsuarioPorId(participante.getPartUsuarioFk().getUsuId());
            participante.setPartUsuarioFk(usu);

            participante = participantesDelegate.guardar(participante);

            if (fichaMB.getFichaTO().getParticipantes() == null) {
                fichaMB.getFichaTO().setParticipantes(new ArrayList<Participantes>());
            }
            fichaMB.getFichaTO().getParticipantes().add(participante);
            limpiarParticipante();
        } catch (BusinessException ex) {
            logger.logp(Level.SEVERE, FichaMB.class.getName(), "agregarInteresadoAction", null, ex);
            List<String> errores = ex.getErrores();

            JSFUtils.agregarMsgs(PARTICIPANTE_POPUP_MSG_ID, errores);
        } catch (TechnicalException ex) {
            logger.logp(Level.SEVERE, FichaMB.class.getName(), "agregarInteresadoAction", null, ex);
            JSFUtils.agregarMsg(PARTICIPANTE_POPUP_MSG_ID, "error_agregar_interesado", null);
        }
        return null;
    }

    public String limpiarParticipante() {
        try {
            participante = new Participantes();
            participante.setPartProyectoFk(null);
            participante.setPartUsuarioFk(new SsUsuario(0));
        } catch (GeneralException ex) {
            logger.logp(Level.SEVERE, FichaMB.class.getName(), "limpiarInteresado", null, ex);
        }
        return null;
    }

    /**
     *
     * @param part
     * @param aprobado null=todos, 0=no aprobados, 1=aprobados.
     * @return
     */
    public String cambiarUsuDetalleHs(Participantes part, Long aprobado) {
        listaEntregablesFiltro = null;
        filtroFechaDesde = null;
        filtroFechaHasta = null;

        if (part != null) {
            renderedHorasGastos = 1;
            participante = part;
            Integer hsAprob = (aprobado != null ? aprobado.intValue() : null);

            revisionHorasListado = registrosHorasDelegate.obtenerRegistrosHoras(participante.getPartUsuarioFk().getUsuId(),
                    participante.getPartProyectoFk().getProyPk(), null,
                    filtroFechaDesde, filtroFechaHasta, null, null, hsAprob);
            revisionHorasListado = RegistroHorasUtils.sortByFecha(revisionHorasListado);

        } else {
            renderedHorasGastos = 0;
            limpiarParticipante();

            fichaMB.cargarResumenParticipantes();
        }

        return null;
    }

    public String eliminarParticipanteAction(Integer partPk) {
        try {
            //Eliminarlo de la base de datos
            participantesDelegate.eliminar(partPk);
            fichaMB.actualizarFichaTO(null);
            fichaMB.cargarResumenParticipantes();
        } catch (GeneralException ge) {
            logger.log(Level.SEVERE, null, ge);
            JSFUtils.agregarMsgs(PARTICIPANTE_MSG_ID, ge.getErrores());
        }

        return null;
    }

    public String eliminarHorasAction(Integer rhPk) {
        try {
            registrosHorasDelegate.eliminarHoras(rhPk);
            for (RegistrosHoras rh : revisionHorasListado) {
                if (rh.getRhPk().equals(rhPk)) {
                    revisionHorasListado.remove(rh);
                    break;
                }
            }
        } catch (BusinessException be) {
            logger.log(Level.SEVERE, be.getMessage(), be);
            JSFUtils.agregarMsgs(PARTICIPANTE_MSG_ID, be.getErrores());
        }
        return null;
    }

    public String editarPart(Participantes part) {
        if (part != null) {
            participante = part;
            listaUsuariosCombo.setSelectedObject(part.getPartUsuarioFk());
            fichaMB.setPartFormDataExpanded(true);
        }
        return null;
    }

    public void cerrarFormCollapsable() {
        fichaMB.cerrarFormCollapsable();
        participante = new Participantes();
        listaUsuariosCombo.setSelected(-1);
    }

    public void aprobarTodo(ValueChangeEvent evt) {
        System.out.println("aprobarTodo Horas");
        PhaseId phaseId = evt.getPhaseId();

        if (phaseId.equals(PhaseId.ANY_PHASE)) {
            evt.setPhaseId(PhaseId.UPDATE_MODEL_VALUES);
            evt.queue();
        } else if (phaseId.equals(PhaseId.UPDATE_MODEL_VALUES)) {
            boolean aprobar = false;
            if (todoAprobado != null && todoAprobado.equals(Boolean.TRUE)) {
                aprobar = true;
            }
            if (revisionHorasListado != null) {
                for (RegistrosHoras rh : revisionHorasListado) {
                    rh.setRhAprobado(aprobar);
                }
            }
        }
    }
}