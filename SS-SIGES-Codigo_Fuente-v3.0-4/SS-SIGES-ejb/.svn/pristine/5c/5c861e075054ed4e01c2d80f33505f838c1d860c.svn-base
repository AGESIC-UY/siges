package com.sofis.business.ejbs;

import com.sofis.business.validations.ParticipantesValidacion;
import com.sofis.data.daos.ParticipantesDao;
import com.sofis.entities.constantes.ConstanteApp;
import com.sofis.entities.constantes.MensajesNegocio;
import com.sofis.entities.data.Participantes;
import com.sofis.entities.data.Proyectos;
import com.sofis.exceptions.BusinessException;
import com.sofis.exceptions.GeneralException;
import com.sofis.exceptions.TechnicalException;
import com.sofis.persistence.dao.exceptions.DAOGeneralException;
import java.util.LinkedList;
import java.util.List;
import java.util.logging.Level;
import java.util.logging.Logger;
import javax.ejb.LocalBean;
import javax.ejb.Stateless;
import javax.inject.Inject;
import javax.inject.Named;
import javax.persistence.EntityManager;
import javax.persistence.PersistenceContext;

/**
 *
 * @author Usuario
 */
@Named
@Stateless(name = "ParticipantesBean")
@LocalBean
public class ParticipantesBean {

    @Inject
    private DatosUsuario du;
    @PersistenceContext(unitName = ConstanteApp.PERSISTENCE_CONTEXT_UNIT_NAME)
    private EntityManager em;
    private static final Logger logger = Logger.getLogger(ConstanteApp.LOGGER_NAME);
    @Inject
    private RegistrosHorasBean registrosHorasBean;

    public Participantes guardar(Participantes participante) throws GeneralException {

        ParticipantesValidacion.validar(participante);
        ParticipantesDao participantesDao = new ParticipantesDao(em);
        try {
            participante = participantesDao.update(participante);
        } catch (BusinessException be) {
            //Si es de tipo negocio envía la misma excepción
            throw be;
        } catch (Exception ex) {
            logger.logp(Level.SEVERE, ParticipantesBean.class.getName(), "guardar", ex.getMessage(), ex);
            TechnicalException ge = new TechnicalException();
            ge.addError(ex.getMessage());
            throw ge;
        }
        return participante;
    }

    public Participantes guardarParticipante(Participantes part) {
        if (part != null) {
            if (part.getPartActivo() == null) {
                part.setPartActivo(Boolean.TRUE);
            }
            return guardar(part);
        }
        return null;

    }

    public Participantes obtenerParticipantesPorPk(Integer partPk) {
        try {
            ParticipantesDao participantesDao = new ParticipantesDao(em);
            return participantesDao.findById(Participantes.class, partPk);
        } catch (BusinessException be) {
            throw be;
        } catch (Exception ex) {
            logger.logp(Level.SEVERE, ParticipantesBean.class.getName(), "obtenerParticipantesPorPk", ex.getMessage(), ex);
            TechnicalException ge = new TechnicalException();
            ge.addError(ex.getMessage());
            throw ge;
        }
    }

    public List<Participantes> obtenerParticipantesPorFichaPk(Integer fichaFk) {
        try {
            ParticipantesDao participantesDao = new ParticipantesDao(em);
            return participantesDao.findByOneProperty(Participantes.class, "partProyectoFk.proyPk", fichaFk);
        } catch (BusinessException be) {
            throw be;
        } catch (Exception ex) {
            logger.logp(Level.SEVERE, ParticipantesBean.class.getName(), "obtenerParticipantesPorFichaPk", ex.getMessage(), ex);
            TechnicalException ge = new TechnicalException();
            ge.addError(ex.getMessage());
            throw ge;
        }
    }

    public void eliminar(Integer partPk) {
        ParticipantesDao participantesDao = new ParticipantesDao(em);

        try {
            Participantes part = participantesDao.findById(Participantes.class, partPk);
            if (part != null) {
                boolean horasAprob = registrosHorasBean.usuTieneHorasAprob(part.getPartUsuarioFk().getUsuId(), part.getPartProyectoFk().getProyPk());
                if (horasAprob) {
                    part.setPartActivo(false);
                    guardar(part);
                } else {
                    participantesDao.delete(part);
                }
            }
        } catch (DAOGeneralException ex) {
            logger.log(Level.SEVERE, ex.getMessage(), ex);
            BusinessException be = new BusinessException();
            be.addError(MensajesNegocio.ERROR_PARTICIPANTE_ELIMINAR);
            throw be;
        }

    }

    public List<Proyectos> obtenerProyectosPorUsuarioParticipante(Integer usuId) {
        List<Proyectos> proyectos = new LinkedList<>();
        try {
            ParticipantesDao participantesDao = new ParticipantesDao(em);
            List<Participantes> parts = participantesDao.findByOneProperty(Participantes.class, "partUsuarioFk.usuId", usuId);
            if (parts != null) {
                for (Participantes part : parts) {
                    proyectos.add(part.getPartProyectoFk());
                }
            }
            return proyectos;
        } catch (BusinessException be) {
            throw be;
        } catch (Exception ex) {
            logger.logp(Level.SEVERE, RegistrosHorasBean.class.getName(), "obtenerProyectosPorUsuarioParticipante", ex.getMessage(), ex);
            TechnicalException ge = new TechnicalException();
            ge.addError(ex.getMessage());
            throw ge;
        }
    }
}
