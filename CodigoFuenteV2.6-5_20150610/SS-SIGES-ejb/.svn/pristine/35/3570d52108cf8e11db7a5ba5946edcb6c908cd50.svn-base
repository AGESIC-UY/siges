package com.sofis.business.ejbs;

import com.sofis.business.properties.LabelsEJB;
import com.sofis.business.utils.EntregablesUtils;
import com.sofis.entities.constantes.ConstanteApp;
import com.sofis.entities.data.Entregables;
import com.sofis.entities.data.Proyectos;
import com.sofis.entities.data.SsUsuario;
import com.sofis.entities.enums.ReporteCroAlcColumnasEnum;
import com.sofis.entities.tipos.FiltroReporteTO;
import com.sofis.entities.tipos.ReporteCroMesTO;
import com.sofis.exceptions.BusinessException;
import com.sofis.generico.utils.generalutils.CollectionsUtils;
import com.sofis.generico.utils.generalutils.DatesUtils;
import com.sofis.generico.utils.generalutils.StringsUtils;
import java.io.ByteArrayOutputStream;
import java.io.IOException;
import java.util.ArrayList;
import java.util.Calendar;
import java.util.Date;
import java.util.GregorianCalendar;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.Set;
import java.util.logging.Level;
import java.util.logging.Logger;
import javax.ejb.LocalBean;
import javax.ejb.Stateless;
import javax.inject.Inject;
import javax.inject.Named;
import javax.persistence.EntityManager;
import javax.persistence.PersistenceContext;
import org.apache.poi.hssf.usermodel.HSSFCell;
import org.apache.poi.hssf.usermodel.HSSFCellStyle;
import org.apache.poi.hssf.usermodel.HSSFPalette;
import org.apache.poi.hssf.usermodel.HSSFRow;
import org.apache.poi.hssf.usermodel.HSSFSheet;
import org.apache.poi.hssf.usermodel.HSSFWorkbook;
import org.apache.poi.hssf.util.HSSFCellUtil;
import org.apache.poi.hssf.util.HSSFColor;
import org.apache.poi.ss.usermodel.CellStyle;

/**
 *
 * @author Usuario
 */
@Named
@Stateless(name = "ReporteCronoAlcanceBean")
@LocalBean
public class ReporteCronoAlcanceBean {

    @PersistenceContext(unitName = ConstanteApp.PERSISTENCE_CONTEXT_UNIT_NAME)
    private EntityManager em;
    private static final Logger logger = Logger.getLogger(ConstanteApp.LOGGER_NAME);

    @Inject
    private EstadosBean estadosBean;
    @Inject
    private CronogramasBean cronogramasBean;
    @Inject
    private ReportesBean reportesBean;
    @Inject
    private EntregablesBean entregablesBean;

    public byte[] generarReportePlanillaPorFiltro(Integer orgPk, FiltroReporteTO filtro, SsUsuario usuario) {

        String hojaName = LabelsEJB.getValue("rep_cro_alc_xls_hoja_alcance");

        //Proyectos obtenidos por medio del filtro.
        List<Proyectos> listProy = reportesBean.buscarProyectosPorFiltro(filtro, orgPk, usuario);

        int anio = filtro.getAnio() != null ? filtro.getAnio() : new GregorianCalendar().get(Calendar.YEAR);
        int filaNro = -1;

        HSSFWorkbook planilla = new HSSFWorkbook();
        HSSFSheet hoja = planilla.createSheet(hojaName);

        HSSFRow rowTitulo = hoja.createRow(++filaNro);
        HSSFCellStyle cellStyleTitle = planilla.createCellStyle();
        HSSFCell celdaTitulo = rowTitulo.createCell(0);
        celdaTitulo.setCellValue(StringsUtils.concat(LabelsEJB.getValue("rep_cro_alc_xls_titulo"), ": ", hojaName));

        cellStyleTitle.setFillBackgroundColor(HSSFColor.RED.index);
        cellStyleTitle.setFillPattern(CellStyle.SOLID_FOREGROUND);
        celdaTitulo.setCellStyle(cellStyleTitle);

        for (int i = 1; i <= ReporteCroAlcColumnasEnum.DICIEMBRE.ordinal(); i++) {
            HSSFCell celdaTit = rowTitulo.createCell(i);
            celdaTit.setCellStyle(cellStyleTitle);
        }

        ++filaNro;
        //Fila titulos columnas
        HSSFRow rowColTitulos = hoja.createRow(++filaNro);
        HSSFCell celda = rowColTitulos.createCell(ReporteCroAlcColumnasEnum.ID_PROG.ordinal());
        celda.setCellValue(LabelsEJB.getValue("rep_cro_alc_xls_col_id"));

        HSSFCellStyle cellStyleColTitulos = planilla.createCellStyle();
        cellStyleColTitulos.setBorderTop(CellStyle.BORDER_THIN);
        cellStyleColTitulos.setBorderBottom(CellStyle.BORDER_THIN);
        cellStyleColTitulos.setFillBackgroundColor(HSSFColor.BLUE.index);
        cellStyleColTitulos.setFillPattern(CellStyle.SOLID_FOREGROUND);

        HSSFCellUtil.createCell(rowColTitulos, ReporteCroAlcColumnasEnum.ID_PROG.ordinal(), LabelsEJB.getValue("rep_cro_alc_xls_col_id"), cellStyleColTitulos);
        HSSFCellUtil.createCell(rowColTitulos, ReporteCroAlcColumnasEnum.PROG.ordinal(), LabelsEJB.getValue("rep_cro_alc_xls_col_prog"), cellStyleColTitulos);
        HSSFCellUtil.createCell(rowColTitulos, ReporteCroAlcColumnasEnum.ID_PROY.ordinal(), LabelsEJB.getValue("rep_cro_alc_xls_col_id"), cellStyleColTitulos);
        HSSFCellUtil.createCell(rowColTitulos, ReporteCroAlcColumnasEnum.PROY.ordinal(), LabelsEJB.getValue("rep_cro_alc_xls_col_proy"), cellStyleColTitulos);
        HSSFCellUtil.createCell(rowColTitulos, ReporteCroAlcColumnasEnum.AREA.ordinal(), LabelsEJB.getValue("rep_cro_alc_xls_col_area"), cellStyleColTitulos);
        HSSFCellUtil.createCell(rowColTitulos, ReporteCroAlcColumnasEnum.GERENTE.ordinal(), LabelsEJB.getValue("rep_cro_alc_xls_col_gerente"), cellStyleColTitulos);
        HSSFCellUtil.createCell(rowColTitulos, ReporteCroAlcColumnasEnum.ESTADO.ordinal(), LabelsEJB.getValue("rep_cro_alc_xls_col_estado"), cellStyleColTitulos);
        HSSFCellUtil.createCell(rowColTitulos, ReporteCroAlcColumnasEnum.TIPO_LINEA.ordinal(), "", cellStyleColTitulos);
        for (int mes = 1; mes <= 12; mes++) {
            String mesName = StringsUtils.concat("date_mes_abreviado_", String.valueOf(mes));
            HSSFCellUtil.createCell(rowColTitulos, obtenerCeldaOrdinalMes(mes), LabelsEJB.getValue(mesName), cellStyleColTitulos);
        }

        //Fila detalles
        for (Proyectos proy : listProy) {
            Set<Entregables> listEnt = proy.getProyCroFk() != null ? proy.getProyCroFk().getEntregablesSet() : null;

            if (CollectionsUtils.isNotEmpty(listEnt)) {
                Map<String, ReporteCroMesTO> valoresCro = obtenerValoresPorTipoMes(listEnt);

                //0-Base, 1-Real, 2-Proyectado
                for (int i = 0; i < 3; i++) {
                    HSSFCellStyle cellStyleAlc = planilla.createCellStyle();
                    if (i == 2) {
                        cellStyleAlc.setBorderBottom(CellStyle.BORDER_THIN);
                    }
                    HSSFRow rowMon = hoja.createRow(++filaNro);
                    columnasProyecto(rowMon, proy, cellStyleAlc);

                    celda = rowMon.createCell(ReporteCroAlcColumnasEnum.TIPO_LINEA.ordinal());
                    celda.setCellValue(nombreTipoLinea(i + 1));
                    celda.setCellStyle(cellStyleAlc);

                    ReporteCroMesTO valorMes = null;
                    for (int mes = 1; mes <= 12; mes++) {
                        if (valoresCro != null) {
                            String clave = i + "-" + mes + "-" + anio;
                            valorMes = valoresCro.get(clave);
                        }
                        if (valorMes == null) {
                            valorMes = new ReporteCroMesTO();
                        }

                        celda = rowMon.createCell(obtenerCeldaOrdinalMes(mes));
                        celda.setCellValue(Math.round(valorMes.getAlcance()));
                        celda.setCellStyle(cellStyleAlc);
                    }
                }
            }
        }

        ByteArrayOutputStream bos = new ByteArrayOutputStream();
        try {
            planilla.write(bos);
            return bos.toByteArray();

        } catch (IOException iOException) {
            logger.log(Level.SEVERE, null, iOException);
            BusinessException be = new BusinessException();
            be.addError("Error al generar el Excel.");
            throw be;
        } catch (Exception ex) {
            logger.log(Level.SEVERE, null, ex);
            BusinessException be = new BusinessException();
            be.addError("Error al generar el Excel.");
            throw be;
        }
    }

    /**
     * Carga las columnas que dependen del Proyecto.
     *
     * @param rowcellStyle@param proy
     * @param rowStyle
     */
    private void columnasProyecto(HSSFRow row, Proyectos proy, HSSFCellStyle cellStyle) {
        HSSFCell celda;
        celda = row.createCell(ReporteCroAlcColumnasEnum.ID_PROG.ordinal());
        celda.setCellStyle(cellStyle);
        String progPk = proy.getProyProgFk() != null ? proy.getProyProgFk().getProgPk().toString() : "";
        celda.setCellValue(progPk);
        celda.setCellStyle(cellStyle);
        celda = row.createCell(ReporteCroAlcColumnasEnum.PROG.ordinal());
        String progName = proy.getProyProgFk() != null ? proy.getProyProgFk().getProgNombre() : "";
        celda.setCellValue(progName);
        celda.setCellStyle(cellStyle);
        celda = row.createCell(ReporteCroAlcColumnasEnum.ID_PROY.ordinal());
        celda.setCellValue(proy.getProyPk());
        celda.setCellStyle(cellStyle);
        celda = row.createCell(ReporteCroAlcColumnasEnum.PROY.ordinal());
        celda.setCellValue(proy.getProyNombre());
        celda.setCellStyle(cellStyle);
        celda = row.createCell(ReporteCroAlcColumnasEnum.AREA.ordinal());
        String area = proy.getProyAreaFk() != null ? proy.getProyAreaFk().getAreaNombre() : "";
        celda.setCellValue(area);
        celda.setCellStyle(cellStyle);
        celda = row.createCell(ReporteCroAlcColumnasEnum.GERENTE.ordinal());
        String gerente = proy.getProyUsrGerenteFk() != null ? proy.getProyUsrGerenteFk().getUsuNombreApellido() : "";
        celda.setCellValue(gerente);
        celda.setCellStyle(cellStyle);
        celda = row.createCell(ReporteCroAlcColumnasEnum.ESTADO.ordinal());
        celda.setCellValue(estadosBean.estadoStr(proy.getProyEstFk()));
        celda.setCellStyle(cellStyle);
    }

    /**
     * Retorna el nombre del tipo de linea. 1-Plan, 2-Real, 3-Proyectado,
     * 4-Aprobado
     *
     * @param i
     * @return String
     */
    private String nombreTipoLinea(int i) {
        switch (i) {
            case 1:
                return LabelsEJB.getValue("rep_cro_alc_tipo_base");
            case 2:
                return LabelsEJB.getValue("rep_cro_alc_tipo_real");
            case 3:
                return LabelsEJB.getValue("rep_cro_alc_tipo_proyectado");
            default:
                return "";
        }
    }

    /**
     * Retorna la columna para el mes indicado.
     *
     * @param mes
     * @return Integer
     */
    private Integer obtenerCeldaOrdinalMes(int mes) {
        switch (mes) {
            case 1:
                return ReporteCroAlcColumnasEnum.ENERO.ordinal();
            case 2:
                return ReporteCroAlcColumnasEnum.FEBRERO.ordinal();
            case 3:
                return ReporteCroAlcColumnasEnum.MARZO.ordinal();
            case 4:
                return ReporteCroAlcColumnasEnum.ABRIL.ordinal();
            case 5:
                return ReporteCroAlcColumnasEnum.MAYO.ordinal();
            case 6:
                return ReporteCroAlcColumnasEnum.JUNIO.ordinal();
            case 7:
                return ReporteCroAlcColumnasEnum.JULIO.ordinal();
            case 8:
                return ReporteCroAlcColumnasEnum.AGOSTO.ordinal();
            case 9:
                return ReporteCroAlcColumnasEnum.SETIEMBRE.ordinal();
            case 10:
                return ReporteCroAlcColumnasEnum.OCTUBRE.ordinal();
            case 11:
                return ReporteCroAlcColumnasEnum.NOVIEMBRE.ordinal();
            case 12:
                return ReporteCroAlcColumnasEnum.DICIEMBRE.ordinal();
            default:
                return null;
        }

    }

    /**
     * Retorna un mapa con los valores por mes y tipo(Base, Real, Proyectado).
     * La clave del mapa es un string de tipo: "0-1-2015". Donde 0 es el tipo, 1
     * es el mes, y 2015 el año.
     *
     * @param listEnt
     * @return Map
     */
    private Map<String, ReporteCroMesTO> obtenerValoresPorTipoMes(Set<Entregables> listEnt) {
        if (CollectionsUtils.isNotEmpty(listEnt)) {
            Map<String, ReporteCroMesTO> result = new HashMap<>();
            Map<String, Double> entPorMes = new HashMap<>();
            Date primera = null;
            Date ultima = null;
            Calendar cal;
            int mes;
            int anio;
            Double entEsfProg;

            List<Entregables> listE = EntregablesUtils.entregablesSinPadres(new ArrayList(listEnt));

            double esfuerzoTotal = 0;
            for (Entregables ent : listE) {
                esfuerzoTotal += ent.getEntEsfuerzo();
            }
//            int countEnt = 0;
            for (Entregables ent : listE) {
                cal = new GregorianCalendar();

                entEsfProg = 0D;
                if (ent.getEntEsfuerzo() != null && ent.getEntProgreso() != null) {
                    entEsfProg = ent.getEntEsfuerzo() * ent.getEntProgreso() / esfuerzoTotal;
                }

                if (ent.getEntInicioLineaBaseDate() != null && ent.getEntFinLineaBaseDate() != null) {
                    cal.setTime(ent.getEntFinLineaBaseDate());
                    mes = cal.get(Calendar.MONTH) + 1;
                    anio = cal.get(Calendar.YEAR);

                    if (primera == null || DatesUtils.esMayor(primera, cal.getTime())) {
                        primera = cal.getTime();
                    }
                    if (ultima == null || DatesUtils.esMayor(cal.getTime(), ultima)) {
                        ultima = cal.getTime();
                    }

                    String claveBase = "0-" + mes + "-" + anio;
                    if (entPorMes.containsKey(claveBase)) {
                        entPorMes.put(claveBase, entPorMes.get(claveBase) + entEsfProg);
                    } else {
                        entPorMes.put(claveBase, entEsfProg);
                    }
                }

                if (ent.getEntInicioDate() != null && ent.getEntFinDate() != null) {
                    cal.setTime(ent.getEntFinDate());
                    mes = cal.get(Calendar.MONTH) + 1;
                    anio = cal.get(Calendar.YEAR);

                    if (primera == null || DatesUtils.esMayor(primera, cal.getTime())) {
                        primera = cal.getTime();
                    }
                    if (ultima == null || DatesUtils.esMayor(cal.getTime(), ultima)) {
                        ultima = cal.getTime();
                    }

                    if (ent.getEntProgreso() >= 100) {
                        String claveReal = "1-" + mes + "-" + anio;
                        if (entPorMes.containsKey(claveReal)) {
                            entPorMes.put(claveReal, entPorMes.get(claveReal) + entEsfProg);
                        } else {
                            entPorMes.put(claveReal, entEsfProg);
                        }
                    } else {
                        String claveProy = "2-" + mes + "-" + anio;
                        if (entPorMes.containsKey(claveProy)) {
                            entPorMes.put(claveProy, entPorMes.get(claveProy) + entEsfProg);
                        } else {
                            entPorMes.put(claveProy, entEsfProg);
                        }
                    }
                }
            }

            Calendar calPrimera = new GregorianCalendar();

            double baseAcu = 0;
            double realAcu = 0;
            double proyAcu = 0;
            Double baseMes;
            Double realMes;
            Double proyMes;
            String claveBase;
            String claveReal;
            String claveProy;

            cal = new GregorianCalendar();
            int mesHoy = cal.get(Calendar.MONTH) + 1;
            int anioHoy = cal.get(Calendar.YEAR);
            while (DatesUtils.esMayor(ultima, primera) || DatesUtils.fechasIguales(primera, ultima)) {
                calPrimera.setTime(primera);
                mes = calPrimera.get(Calendar.MONTH) + 1;
                anio = calPrimera.get(Calendar.YEAR);

                claveBase = "0-" + mes + "-" + anio;
                claveReal = "1-" + mes + "-" + anio;
                claveProy = "2-" + mes + "-" + anio;

                baseMes = entPorMes.get(claveBase);
                baseAcu += (baseMes != null ? baseMes : 0);
                result.put(claveBase, new ReporteCroMesTO(baseAcu));

                realMes = entPorMes.get(claveReal);
                realAcu += (realMes != null ? realMes : 0);
                if (anio < anioHoy || (anio == anioHoy && mes <= mesHoy)) {
                    result.put(claveReal, new ReporteCroMesTO(realAcu));
                }

                proyMes = entPorMes.get(claveProy);
                proyAcu += (proyMes != null ? proyMes : 0);
                if (anio < anioHoy || (anio == anioHoy && mes <= mesHoy)) {
                    result.put(claveProy, new ReporteCroMesTO(proyAcu));
                } else {
                    result.put(claveProy, new ReporteCroMesTO(proyAcu + realAcu));
                }

                calPrimera.add(Calendar.MONTH, 1);
                primera = calPrimera.getTime();
            }

            return result;
        }
        return null;
    }
}
